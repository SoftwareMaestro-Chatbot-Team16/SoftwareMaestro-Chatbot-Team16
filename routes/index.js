// routes/index.js
const express = require('express');
const router = express.Router();

const libKakaoWork = require('../libs/kakaoWork');

router.get('/', async (req, res, next) => {
  // ìœ ì € ëª©ë¡ ê²€ìƒ‰ (1)
  const users = await libKakaoWork.getUserList();

  // ê²€ìƒ‰ëœ ëª¨ë“  ìœ ì €ì—ê²Œ ê°ê° ì±„íŒ…ë°© ìƒì„± (2)
  const conversations = await Promise.all(
    users.map((user) => libKakaoWork.openConversations({ userId: user.id }))
  );

  // ìƒì„±ëœ ì±„íŒ…ë°©ì— ë©”ì„¸ì§€ ì „ì†¡ (3)
  const messages = await Promise.all([
    conversations.map((conversation) =>
      libKakaoWork.sendMessage({
        conversationId: conversation.id,
        text: 'ì„¤ë¬¸ì¡°ì‚¬ ì´ë²¤íŠ¸',
        blocks: [
          {
            type: 'header',
            text: 'â˜• ì‚¬ë‚´ ì¹´í˜ ë§Œì¡±ë„ ì¡°ì‚¬ ğŸ¥¤',
            style: 'blue',
          },
          {
            type: 'text',
            text:
              'ì–´ëŠë§ ì‚¬ë‚´ì¹´í˜ê°€ ë°”ë€ì§€ í•œë‹¬ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.\nêµ¬ë¥´ë¯¸ë“¤ì´ ì¹´í˜ë¥¼ ì´ìš©í•˜ê³  ê³„ì‹ ì§€ ì˜ê²¬ì„ ë“¤ì–´ë³´ê³ ì ì„¤ë¬¸ ì¡°ì‚¬ë¥¼ ì§„í–‰í•´ë´…ë‹ˆë‹¤!!\nì„¤ë¬¸ì— ì°¸ì—¬í•˜ë©´ í‘¸ì§í•œ ê²½í’ˆ ì°¬ìŠ¤ê°€ìˆìœ¼ë‹ˆ ìƒí’ˆ ê¼­ ë°›ì•„ê°€ì„¸ìš”! ğŸ',
            markdown: true,
          },
          {
            type: 'button',
            action_type: 'call_modal',
            value: 'cafe_survey',
            text: 'ì„¤ë¬¸ ì°¸ì—¬í•˜ê¸°',
            style: 'default',
          },
        ],
      })
    ),
  ]);

  // ì‘ë‹µê°’ì€ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì…”ë„ ë©ë‹ˆë‹¤.
  res.json({
    users,
    conversations,
    messages,
  });
});
module.exports = router;